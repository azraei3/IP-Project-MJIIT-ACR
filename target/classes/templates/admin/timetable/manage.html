<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Admin - Timetable Management</title>
    <style>
        /* --- KEEP YOUR EXISTING STYLES --- */
        .search-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .custom-dropdown { position: relative; min-width: 220px; }
        .custom-dropdown-btn { width: 100%; padding: 12px; background: white; border: 2px solid #333; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .custom-dropdown-content { display: none; position: absolute; top: 105%; left: 0; width: 100%; background: white; border: 2px solid #333; border-radius: 5px; z-index: 1000; max-height: 300px; overflow-y: auto; }
        .custom-dropdown-content.active { display: block; }
        .dropdown-item-custom { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .dropdown-item-custom:hover { background: #f0f0f0; }
        
        /* Calendar Styles */
        .calendar-header { display: flex; justify-content: space-between; padding: 10px; background: #eee; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; padding: 10px; }
        .calendar-day { padding: 8px; text-align: center; cursor: pointer; border-radius: 4px; }
        .calendar-day:hover { background-color: #ddd; }

        /* Timetable Grid */
        .timetable-container { overflow-x: auto; background: white; border: 2px solid #333; border-radius: 5px; margin-top: 20px; }
        .timetable { border-collapse: collapse; width: 100%; empty-cells: show; min-width: 1000px; }
        .timetable th, .timetable td { 
            border: 1px solid #ccc; 
            padding: 5px; 
            text-align: center; 
            min-width: 60px; 
            height: 50px; 
            vertical-align: middle;
        }
        .timetable th { background-color: #d4a5a5; color: #333; padding: 10px; }
        .day-cell { background-color: #f0f0f0; font-weight: bold; width: 120px; }
        
        /* --- STATUS COLORS --- */
        .selectable { cursor: pointer; transition: 0.2s; }
        .selectable:hover { background-color: #e6fffa; }
        
        /* Selected (Green Check) */
        .selectable.selected { background-color: #48bb78 !important; color: white; }
        
        /* Booked (Red) */
        .selectable.booked { background-color: #e53e3e !important; color: white; cursor: pointer; font-size: 11px; }
        
        /* Pending (Orange) - NEW */
        .selectable.pending { background-color: #ed8936 !important; color: white; cursor: pointer; font-size: 11px; }

        /* Admin Tabs */
        .admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; }
        .admin-tab-btn { padding: 10px 20px; border: 2px solid #333; background: white; border-radius: 5px; font-weight: bold; text-decoration: none; color: black; }
        .admin-tab-btn.active { background: #333; color: white; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .custom-modal { background: white; padding: 30px; border-radius: 10px; width: 500px; border: 2px solid #333; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .calendar-day.disabled { 
            color: #ccc; 
            cursor: not-allowed; 
            background-color: #f9f9f9;
        }
        .selectable.past-slot {
            background-color: #f4f4f4; 
            cursor: not-allowed;
            background-image: linear-gradient(45deg, #f4f4f4 25%, #eeeeee 25%, #eeeeee 50%, #f4f4f4 50%, #f4f4f4 75%, #eeeeee 75%, #eeeeee 100%);
            background-size: 10px 10px;
        }
        .cell-text {
            display: block;
            width: 100%;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 11px; /* Smaller font to fit more text */
            line-height: 1.2;
            padding: 0 2px;
        }
    </style>
</head>
<body>

    <div layout:fragment="content">
        <div>
            <div class="admin-tabs">
                <a th:href="@{/admin/dashboard}" class="admin-tab-btn">Dashboard</a>
                <a th:href="@{/admin/bookings}" class="admin-tab-btn">Requests</a>
                <a th:href="@{/admin/timetable}" class="admin-tab-btn active">Timetable</a>
                <a th:href="@{/admin/logbook}" class="admin-tab-btn">Logbook</a>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body">
                    
                    <div class="search-container">
                        <div class="custom-dropdown">
                            <div class="custom-dropdown-btn" onclick="toggleDropdown('roomDropdown')">
                                <span id="selectedRoomText">Select Room...</span>
                                <i class="bi bi-chevron-down"></i>
                            </div>
                            <div id="roomDropdown" class="custom-dropdown-content">
                                <div th:each="room : ${rooms}" 
                                     class="dropdown-item-custom"
                                     th:data-id="${room.roomId}"
                                     th:data-name="${room.name}"
                                     th:onclick="selectRoom(this.getAttribute('data-id'), this.getAttribute('data-name'))">
                                     <span th:text="${room.name}"></span>
                                     <small class="text-muted" th:text="${' (' + room.capacity + ' pax)'}"></small>
                                </div>
                            </div>
                            <input type="hidden" id="selectedRoomId">
                        </div>

                        <div class="custom-dropdown">
                            <div class="custom-dropdown-btn" onclick="toggleDropdown('dateDropdown')">
                                <span id="selectedDateText">Select Date...</span>
                                <i class="bi bi-calendar"></i>
                            </div>
                            <div id="dateDropdown" class="custom-dropdown-content" style="width: 300px;">
                                <div class="calendar-header">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(-1)">&lt;</button>
                                    <span id="currentMonthYear" style="font-weight: bold;"></span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(1)">&gt;</button>
                                </div>
                                <div id="calendarDays" class="calendar-grid"></div>
                            </div>
                            <input type="hidden" id="selectedDateRaw">
                        </div>

                        <button class="btn btn-dark" style="border: 2px solid #333; font-weight: bold; padding: 0 30px;" onclick="loadTimetable()">
                            Load Timetable
                        </button>
                    </div>

                    <div class="d-flex gap-3 mb-3 small">
                        <div class="d-flex align-items-center"><span style="width:15px; height:15px; border:1px solid #ccc; background:white; margin-right:5px;"></span> Available</div>
                        <div class="d-flex align-items-center"><span style="width:15px; height:15px; background:#48bb78; margin-right:5px;"></span> Selected</div>
                        <div class="d-flex align-items-center"><span style="width:15px; height:15px; background:#e53e3e; margin-right:5px;"></span> Approved</div>
                        <div class="d-flex align-items-center"><span style="width:15px; height:15px; background:#ed8936; margin-right:5px;"></span> Pending</div>
                    </div>

                    <div th:if="${selectedRoomName}" class="alert alert-info d-flex align-items-center mb-3">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <div>
                            <strong>Viewing:</strong> <span th:text="${selectedRoomName}">Room</span> 
                            <span> | Week of: </span> <span th:text="${selectedDate}">Date</span>
                        </div>
                    </div>

                    <div class="timetable-container">
                        <table class="timetable">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th th:each="i : ${#numbers.sequence(8, 23)}" 
                                        th:text="${(i < 10 ? '0' + i : i) + ':00'}">08:00</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${weekDays == null}">
                                    <td colspan="17" style="padding: 20px; color: #666;">Please select a Room and Date to load the timetable.</td>
                                </tr>

                                <tr th:if="${weekDays != null}" th:each="dayName : ${weekDays}">
                                    <td class="day-cell">
                                        <div th:text="${dayName}">Sunday</div>
                                        <div style="font-size: 11px; color: #666;" 
                                             th:text="${weekDates.get(dayName)}">2026-01-02</div>
                                    </td>
                                    
                                    <td th:each="i : ${#numbers.sequence(8, 23)}"
                                        th:with="hourStr=${i < 10 ? '0' + i : i},
                                                timeLabel=${hourStr + ':00'},
                                                currentDate=${weekDates.get(dayName)},
                                                timeKey=${currentDate + '_' + timeLabel},
                                                booking=${scheduleMap != null ? scheduleMap.get(timeKey) : null},
                                                isBooked=${booking != null},
                                                isMine=${isBooked and booking.user.username == currentUsername},
                                                isPast=${#temporals.createDate(currentDate, 'yyyy-MM-dd').isBefore(#temporals.createToday())}"

                                    th:classappend="${isBooked} ? (${isMine} ? 'my-booking selectable' : 'booked selectable') : (${isPast} ? 'selectable past-slot' : 'selectable')"
                                        
                                    th:title="${isBooked} ? ('Subject: ' + booking.purpose + '&#10;' + 'User: ' + booking.user.fullName + '&#10;' + 'Phone: ' + booking.tel) : 'Available'"

                                        th:attr="data-time=${timeLabel}, 
                                        data-date=${currentDate}, 
                                        data-booking-id=${isBooked ? booking.id : ''},
                                        data-subject=${isBooked ? booking.purpose : ''},
                                        data-desc=${isBooked ? booking.description : ''},
                                        data-user=${isBooked ? booking.user.fullName : ''},
                                        data-phone=${isBooked ? booking.tel : ''}"
                                        onclick="handleSlotClick(this)">
                                        
                                        <span th:if="${isBooked}" th:text="${booking.status == 'pending' ? 'Pending' : 'Booked'}"></span>
                                        <span th:unless="${isBooked}">&nbsp;</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <button class="btn btn-dark w-100 mt-3 p-3 fw-bold" onclick="openAddModal()">
                        Create Booking / Class
                    </button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="addModal">
            <div class="custom-modal">
                <h4>Add New Booking (Admin)</h4>
                <form th:action="@{/admin/create-class}" method="post">
                    <input type="hidden" name="roomId" id="formRoomId">
                    <input type="hidden" name="date" id="formDate">
                    <input type="hidden" name="slots" id="formSlots"> 

                    <div class="mb-3">
                        <label class="form-label">Title / Subject</label>
                        <input type="text" name="subject" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3 p-2 border border-secondary border-dashed rounded bg-light">
                        <label class="fw-bold">Recurrence</label>
                        <select name="recurrence" id="recurrenceSelect" class="form-select mb-2" onchange="toggleRecurrence()">
                            <option value="NONE">One-time only</option>
                            <option value="WEEKLY">Weekly</option>
                            <option value="MONTHLY">Monthly</option>
                        </select>
                        <div id="recurrenceEndDiv" style="display:none;">
                            <label class="small text-muted">Repeat Until:</label>
                            <input type="date" name="endDate" class="form-control">
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-fill" onclick="closeModals()">Cancel</button>
                        <button type="submit" class="btn btn-dark flex-fill">Confirm</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal-overlay" id="manageModal">
            <div class="custom-modal">
                <h4 class="text-danger">Manage Booking</h4>
                
                <div class="alert alert-light border">
                    <div class="mb-2"><strong>User:</strong> <span id="mUser">...</span></div>
                    <div class="mb-2"><strong>Phone:</strong> <span id="mPhone">...</span></div>
                    <div class="mb-2"><strong>Subject:</strong> <span id="mSubject">...</span></div>
                    <div class="mb-0"><strong>Description:</strong> <span id="mDesc" class="text-muted small">...</span></div>
                </div>
                
                <form th:action="@{/admin/delete-booking}" method="post">
                    <input type="hidden" name="bookingId" id="mBookingId">
                    <div class="mb-3">
                        <label class="form-label">Cancellation Reason</label>
                        <textarea name="reason" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary flex-fill" onclick="closeModals()">Back</button>
                        <button type="submit" class="btn btn-danger flex-fill">Delete Booking</button>
                    </div>
                </form>
            </div>
        </div>

    </div> 
    
    <th:block layout:fragment="script">
    <script th:inline="javascript">
        
        // --- 1. Persist Dropdown Values on Reload ---
        document.addEventListener("DOMContentLoaded", function() {
            const urlParams = new URLSearchParams(window.location.search);
            const rId = urlParams.get('roomId');
            const dStr = urlParams.get('date');

            /*[+
                let sRoomName = [[${selectedRoomName}]];
            +]*/

            if(rId && sRoomName) {
                document.getElementById('selectedRoomText').innerText = sRoomName;
                document.getElementById('selectedRoomId').value = rId;
                document.getElementById('formRoomId').value = rId;
            }
            if(dStr) {
                document.getElementById('selectedDateText').innerText = dStr;
                document.getElementById('selectedDateRaw').value = dStr;
                document.getElementById('formDate').value = dStr;
            }
        });

        // --- 2. Handle Slot Click (With Past Date Protection) ---
        function handleSlotClick(cell) {
            const dateStr = cell.getAttribute('data-date');
            const today = new Date();
            today.setHours(0,0,0,0);
            const cellDate = new Date(dateStr);

            // Prevent editing past dates
            if (cellDate < today) {
                if (cell.classList.contains('booked') || cell.classList.contains('pending')) {
                    // OPTIONAL: Still show details for past bookings (Read-Only)
                    document.getElementById('mUser').innerText = cell.getAttribute('data-user') || "Unknown"; 
                    document.getElementById('mPhone').innerText = cell.getAttribute('data-phone') || "-";
                    document.getElementById('mSubject').innerText = cell.getAttribute('data-subject');
                    document.getElementById('mDesc').innerText = cell.getAttribute('data-desc') || "No description";
                    
                    // Hide delete button or show alert
                    alert("Past bookings details:\n" + 
                        "User: " + cell.getAttribute('data-user') + "\n" +
                        "Phone: " + cell.getAttribute('data-phone'));
                    return;
                }
                return;
            }

            // Handle Future Bookings
            if (cell.classList.contains('booked') || cell.classList.contains('pending')) {
                // 1. Populate Modal with new data
                document.getElementById('mUser').innerText = cell.getAttribute('data-user') || "Unknown"; 
                document.getElementById('mPhone').innerText = cell.getAttribute('data-phone') || "-";
                document.getElementById('mSubject').innerText = cell.getAttribute('data-subject');
                document.getElementById('mDesc').innerText = cell.getAttribute('data-desc') || "No description";
                document.getElementById('mBookingId').value = cell.getAttribute('data-booking-id');
                
                // 2. Show Modal
                document.getElementById('manageModal').classList.add('active');
            } else {
                cell.classList.toggle('selected');
            }
        }

        // --- 3. Open Add Modal ---
        function openAddModal() {
            const selectedCells = document.querySelectorAll('.selectable.selected');
            if (selectedCells.length === 0) {
                alert("Please select time slots first.");
                return;
            }

            let firstDate = selectedCells[0].getAttribute('data-date');
            let consistent = true;
            let times = [];

            selectedCells.forEach(cell => {
                if(cell.getAttribute('data-date') !== firstDate) consistent = false;
                times.push(cell.getAttribute('data-time'));
            });

            if(!consistent) {
                alert("Please select slots from a single day only.");
                return;
            }

            document.getElementById('formDate').value = firstDate;
            document.getElementById('formSlots').value = JSON.stringify(times.sort());
            document.getElementById('addModal').classList.add('active');
        }

        function loadTimetable() {
            const room = document.getElementById('selectedRoomId').value;
            const date = document.getElementById('selectedDateRaw').value;
            if(!room || !date) { alert("Select Room and Date"); return; }
            window.location.href = `/admin/timetable?roomId=${room}&date=${date}`;
        }

        // --- UI Utilities ---
        function toggleDropdown(id) {
            document.querySelectorAll('.custom-dropdown-content').forEach(el => {
                if(el.id !== id) el.classList.remove('active');
            });
            document.getElementById(id).classList.toggle('active');
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.custom-dropdown-content').forEach(el => el.classList.remove('active'));
            }
        });

        function closeModals() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
        }

        function selectRoom(id, name) {
            document.getElementById('selectedRoomText').innerText = name;
            document.getElementById('selectedRoomId').value = id;
            document.getElementById('formRoomId').value = id;
            toggleDropdown('roomDropdown');
        }

        // --- 4. Calendar Logic (Gray out Past Dates) ---
        let currentDate = new Date();
        
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDayIndex = firstDay.getDay(); 
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentMonthYear').innerText = `${monthNames[month]} ${year}`;
            
            const grid = document.getElementById('calendarDays');
            grid.innerHTML = "";
            
            // Helper for "Today" check
            const today = new Date();
            today.setHours(0,0,0,0);

            for (let i = 0; i < startDayIndex; i++) {
                let div = document.createElement('div');
                div.className = 'calendar-day empty';
                grid.appendChild(div);
            }
            
            for (let d = 1; d <= daysInMonth; d++) {
                let div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerText = d;
                
                let thisDate = new Date(year, month, d);
                let dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                // DISABLE PAST DATES
                if (thisDate < today) {
                    div.classList.add('disabled'); // Uses your CSS .disabled style
                } else {
                    div.onclick = () => {
                        document.getElementById('selectedDateText').innerText = `${d} ${monthNames[month]}`;
                        document.getElementById('selectedDateRaw').value = dateStr;
                        document.getElementById('formDate').value = dateStr;
                        toggleDropdown('dateDropdown');
                    };
                }
                grid.appendChild(div);
            }
        }
        function changeMonth(step) {
            currentDate.setMonth(currentDate.getMonth() + step);
            renderCalendar();
        }
        renderCalendar();

        function toggleRecurrence() {
            const val = document.getElementById('recurrenceSelect').value;
            document.getElementById('recurrenceEndDiv').style.display = (val === 'NONE') ? 'none' : 'block';
        }
    </script>
</th:block>
</body>
</html>